
<div class="row">
  <div class="mx-auto d-block col-md-10 col-lg-5">
    <h1 class="spot_name"><%= @spot.name %></h1>
    <div id='spot_map'></div>
    <div class="favorite">
      <% if current_user.like?(@spot) %>
        <%= form_with(model: current_user.favorites.find_by(spot_id: @spot.id), local: true, method: :delete) do |f| %>
          <%= hidden_field_tag :spot_id, @spot.id %>
          <%= hidden_field_tag :page_id, 4 %>
          <%= f.submit 'お気に入り解除', data: { confirm: "本当にお気に入り解除しますか?" }, class: 'btn btn-danger btan mx-auto d-block' %>
        <% end %>
      <% else %>
        <%= form_with(model: current_user.favorites.build, local: true) do |f| %>
          <%= hidden_field_tag :spot_id, @spot.id %>
          <%= f.submit 'お気に入り登録', class: 'btn btn-primary btan mx-auto d-block' %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="mx-auto d-block col-sm-9 col-md-8 col-lg-6">
    <p class="spot_e">&emsp;<%= @spot.explanation %></p>
  </div>
</div>

<div class="box-title mx-auto d-block">コメント一覧</div>
<div class="box2 mx-auto d-block">
  <div>
    <% @comments.each do |c| %>
      <div>
        <a href="/users/<%= c.user.id %>"><%= c.user.name %></a><%= @comment.created_at %>
      </div>
      <div>
        <%= safe_join("#{c.content}".split("\n"),tag(:br)) %>
      </div>
      <div class="cimg">
        <%= link_to c.image.url, "data-lightbox" => c.image.url do %>
          <%= image_tag c.image.url, alt: "", class: "comment_img" if c.image? %>
        <% end %>
      </div>
      <div class="botton">
        <% if current_user == c.user %>
          &nbsp;<%= link_to "削除", spot_comment_path(@spot,c,page_id: 2), method: :delete, data: { confirm: "本当に削除しますか?" }, class: 'btn btn-danger btn-sm' %>
        <% end %>
      </div>
      <hr>
    <% end %>
  </div>
    
  <%= paginate @comments %>
  
  
  <div class="text">
    <%= form_with(model: [@spot, @comment], local: true) do |f| %>
    <%= render 'layouts/error_messages', model: f.object %>
      <%= f.label :画像も投稿できるよ！, class: "text-primary" %><br />
      <%= f.file_field :image, id: "comment_画像も投稿できるよ！" %>
      <%= f.text_area :content, class: 'form-control js-text',id: "cmnt",  :placeholder => "釣果などをコメントしよう！" %>
      <p class="js-text-count pull-right"></p>
      <div class="commentbtn">
        <%= f.submit 'コメントする', class: 'btn btn-info' %>
      </div>
    <% end %>
  </div>
</div>

<script>
function initMap() {

  var test ={lat: <%= @spot.latitude %>, lng: <%= @spot.longitude %>};
  var map = new google.maps.Map(document.getElementById('spot_map'), {
            zoom: 16, 
            center: test
            });
  var transitLayer = new google.maps.TransitLayer();
  transitLayer.setMap(map);

  var contentString = '<%= @spot.address %>';
  var infowindow = new google.maps.InfoWindow({
    content: contentString
  });


  var marker = new google.maps.Marker({
                position:test,
                map: map,
                title: contentString
               });

   marker.addListener('click', function() {
     infowindow.open(map, marker);
   });
}
  
$(function (){
  
  var count = $(".js-text").text().replace(/\n/g, "改行").length;
  
  var now_count = 150 - count;
  
  if (count > 150) {
    $(".js-text-count").css("color","red");
  }
  $(".js-text-count").text( "残り" + now_count + "文字");

  $(".js-text").on("keyup", function() {

    var count = $(this).val().replace(/\n/g, "改行").length;
    var now_count = 150 - count;

    if (count > 150) {
      $(".js-text-count").css("color","red");
    } else {
      $(".js-text-count").css("color","black");
    }
    $(".js-text-count").text( "残り" + now_count + "文字");
  });
});
</script>